```{r}
#| echo: false

## align wd with html dir
# setwd ("~/myDocs/amyfiles/NOAA-LCI/MonthlyUpdates")
## can this from from standard NOAA-LCI ? 

## clear the slate
rm (list=ls())
unlink ("MonthlyUpdates/media/", recursive=TRUE)


## fetch data from notebook export and CTD processing
load ("~/tmp/LCI_noaa/cache/CTDcasts.RData")  # from dataSetup.R -- contains physOc -- raw CTD profiles
physOc$isoDate <- as.Date (physOc$isoTime)
physL <- subset (physOc, isoDate == max (isoDate))
rm (physOc)

# minT = min (c(10.5, 10.6, 9.8, 11))
# maxT = max (c(13, 15, 14, 12))
# sDate = as.Date (Sys.Date())
# sDate = as.Date ("2024-08-26")
sDate <- physL$isoDate [1]
sY = as.numeric (format (sDate, "%Y"))
sM = month.name [as.numeric (format (sDate, "%m"))]
sSlot= paste (sM, sY)

crew = c("Hans", "Dom", "Martin") |> sort()  ## pull from notes
crewT = paste0 (c (paste0 (crew [1:(length (crew)-1)], collapse = ", "),
                 paste0 (crew [length (crew)])), collapse = ", and ")


tsal <- with (physL, data.frame (temSal = c(min (Temperature_ITS90_DegC, na.rm=TRUE),
                                             max (Temperature_ITS90_DegC, na.rm=TRUE),
                                             min (Salinity_PSU, na.rm=TRUE),
                                             max (Salinity_PSU, na.rm=TRUE)),
                                  stn = c(Match_Name [which.min (Temperature_ITS90_DegC)],
                                          Match_Name [which.max (Temperature_ITS90_DegC)],
                                          Match_Name [which.min (Salinity_PSU)],
                                          Match_Name [which.max (Salinity_PSU)]),
                                  depth= c(Depth.saltwater..m. [which.min (Temperature_ITS90_DegC)],
                                          Depth.saltwater..m. [which.max (Temperature_ITS90_DegC)],
                                          Depth.saltwater..m. [which.min (Salinity_PSU)],
                                          Depth.saltwater..m. [which.max (Salinity_PSU)])
                                  ))
tsal$temSalR <- round (tsal$temSal, 1)
tsal$depthT <- ifelse (tsal$depth > 5, "depth", "surface")
# tsal$region <- tsal$stn
# tsal$region <- gsub ("AlongBay_[7:13]", tsal$region, "inner bay")
# tsal$region <- gsub ("AlongBay_[1:6]", tsal$region, "outer bay")
# tsal$region <- gsub ("T4_[1:10]", tsal$region, "outer bay")
# tsal$region <- ifelse (tsal$region %in% (c("outer bay", "inner bay")), tsal$region, "Cook Inlet")


## to-do: 
## tweak title layout : remove "author" and "affiliation"
## add date? 
## add background graphics, NCCOS logo



## ----------------------------------------------------------------------
## copy files for figures

# Struggling with path settings -- circumvent this issue by copying relevant file to local directory

  ## find files
  ## construct mark-down code (all sections of the day, monthly / quarterly)
  dest="media/CTDsections/sectionImages/"
  dir.create(dest, showWarnings=FALSE, recursive=TRUE)
  
  fl <- list.files(paste0 ("~/tmp/LCI_noaa/", dest), pattern="*.png")
  # pick only transects from last survey; flexible as to monthly/quarterly
  flS <- grep (substr(sort (fl, decreasing=TRUE)[1], 1,10), fl, value=TRUE) 
  cS <- file.copy(from=paste0 ("~/tmp/LCI_noaa/", dest, flS),
            to=dest, overwrite=TRUE
            )
  fl <- list.files (dest, pattern="*.png")
  Tran <- substr (fl, 12, nchar (fl))
  Tran <- gsub (".png", "", Tran, fixed=TRUE)
  
  ## generating strings for all transects -- not yet working
#  iStrng <- paste0 ("![", Tran, "](", dest, fl, ")")
  iStrng <- paste0 (dest, fl)
#  iStrng <- paste0 ("MonthlyUpdates/", dest, fl)
  transectSection1 <- iStrng [1]
  transectSection2 <- iStrng [2]

  try ({
    transectSection3 <- iStrng [3]
    transectSection4 <- iStrng [4]
  })
  
  
  
  ## Chlorophyll
  dest="media/CTDsections/time-sections/"
  dir.create(dest, showWarnings=FALSE, recursive=TRUE)
  flS <- list.files (paste0 ("~/tmp/LCI_noaa/", dest), pattern="*.png")
  cS <- file.copy (from=paste0 ("~/tmp/LCI_noaa/", dest, flS)
                   , to=dest, overwrite=TRUE)
  TStempSurface <- paste0 (dest, "5-TempSurfaceTS.png")
  TSsalinitySurface <- paste0 (dest, "5-SalSurfaceTS.png")
  TSchlorophyll <- paste0 (dest, "3-9_6-fluorescence-climatology.png")
  TS_tsprofile <- paste0 (dest, "2-9_6-TSprofile.png")
  
  ## NOAA weather -- replace from rNOAA
  
  rm (fl, flS, dest, cS)
```




---
title: "Monthly Kachemak Bay report, `{r} sSlot`"
author: 
  - name: "Martin Renner"
    email: martin.renner@noaa.gov
    affiliation:
      - name: CSS, under contract to Kasitsna Bay Lab, NCCOS, NOAA
        address: 81 Sterling Highway
        city: Homer
        state: Alaska
        postal-code: 99603

format: html  # or pdf or word
editor: visual
# title-block-style: none
# in terminal: quarto render --to pdf
---

## Conditions

On `{r} sDate`, `{r} crewT` went out to conduct our monthly survey. 


Wind and precipitation. Introductory remarks

## Physical oceanography
Current conditions, long-term anomalies:

### Temperature
Water temperatures ranged from 
`{r} tsal$temSalR[1]` $^\circ$C at station `{r} tsal$stn[1]` and depth of `{r} tsal$depth[1]` m to 
`{r} tsal$temSalR[2]` $^\circ$C at `{r} tsal$stn[2]` (`{r} tsal$depth[2]` m depth).

### Salinity
Salinity values ranged from 
`{r} tsal$temSalR[3]` PSU at `{r} tsal$stn[3]` (`{r} tsal$depth[3]`m depth) to 
`{r} tsal$temSalR[4]` at `{r} tsal$stn[3]` (`{r} tsal$depth[3]`m depth).

Salinity anomaly and seasonality. Anomaly of depth-profile. Min and max values? 

### Stratification, turbidity, remarks
Seasonality and anomaly of strength of stratification (AlongBay 10) Seasonality of turbidity? AlongBay 02. Inner bay: glacial plume too erratic?

## Biological conditions

### Phytoplankton

Fluorescence compared to the last 12 months

Fluorescence compared to long-term mean.

![Chlorophyll concentration](./`{r} TSchlorophyll`)


### Zooplankton

Backscatter? Species composition?

### Wildlife

Sightings of whales, seaotters, birds, zooplankton.


## Appendix

::: {#fig-elements layout-ncol=1}
![AlongBay](./`{r} transectSection1`)

![T9](./`{r} transectSection2`)

Longitudinal sections of main parameters.
:::

More figures: signature data = time series. Start with figures as-is, then elaborate on them (improving on anomaly plots).

Add map with station numbers -- schematic
